<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台北市 Ubike 站點查詢</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLvSgkEpDffUOt9_97LWNtg5gQS84nARE&libraries=places"></script>
    <!-- MarkerClusterer Library -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    <style>
      #map {
        height: calc(100vh - 56px);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <h1 class="text-light navbar-brand m-0">台北市 Ubike 站點查詢</h1>
      </div>
    </nav>

    <div class="bg-light p-2">
      <div class="btn-group w-100" role="group">
        <button
          type="button"
          class="btn btn-primary active"
          onclick="window.location.href='./combine_Gmap_LeafLetMap2.html'"
        >
          Google Maps
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="window.location.href='./combine_Gmap_LeafLetMap.html'"
        >
          Leaflet
        </button>
      </div>
    </div>
    <div id="map"></div>
    <script>
      // Google Map initialization
      let map;
      let markers = [];
      let markerCluster;
      let currentInfoWindow = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 25.03416068163684, lng: 121.56454962636319 },
          zoom: 12,
          gestureHandling: "greedy"
        });

        // Load data and set markers
        fetchUbikeData();
      }

      async function fetchUbikeData() {
        const UBIKE_TAIPEI =
          "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";
        const data = await fetch(UBIKE_TAIPEI).then((res) => res.json());

        data.forEach((station) => {
          // Create marker for each station
          const marker = new google.maps.Marker({
            position: { lat: station.latitude, lng: station.longitude },
            map: map,
            title: station.sna,
          });

          // InfoWindow with station details
          const infoWindowContent = `
            <div class="p-3">
              <div class="mb-3">
                <h5 class="mb-2">${station.sna.split("_")[1]}</h5>
                <p class="mb-1"><i class="fa-solid fa-location-dot me-2"></i>${
                  station.ar
                }</p>
                <p class="mb-1"><i class="fa-solid fa-map me-2"></i>${
                  station.sarea
                }</p>
              </div>
              
              <div class="mb-3">
                <table class="table table-bordered text-center">
                  <thead class="table-light">
                    <tr>
                      <th>總車位</th>
                      <th>可租借</th>
                      <th>可歸還</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>${station.total}</td>
                      <td class="text-success">${
                        station.available_rent_bikes
                      }</td>
                      <td class="text-primary">${
                        station.available_return_bikes
                      }</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mb-2">
                <p class="mb-1 text-muted small">
                  <i class="fa-regular fa-clock me-2"></i>站點更新：${new Date(
                    station.mday
                  ).toLocaleString()}
                </p>
                <p class="mb-0 text-muted small">
                  <i class="fa-solid fa-rotate me-2"></i>系統更新：${new Date(
                    station.srcUpdateTime
                  ).toLocaleString()}
                </p>
              </div>

              <div class="mt-3 text-center">
                <span class="badge ${
                  station.act === "1" ? "bg-success" : "bg-danger"
                }">
                  <i class="fa-solid ${
                    station.act === "1" ? "fa-check" : "fa-xmark"
                  } me-1"></i>
                  ${station.act === "1" ? "營運中" : "暫停營運"}
                </span>
              </div>
            </div>
          `;

          const infowindow = new google.maps.InfoWindow({
            content: infoWindowContent,
          });

          // Add click event to show infoWindow
          marker.addListener("click", () => {
            if (currentInfoWindow) {
              currentInfoWindow.close();
            }
            infowindow.open(map, marker);
            currentInfoWindow = infowindow;
          });

          markers.push(marker);
        });

        // 初始化 MarkerClusterer
        markerCluster = new markerClusterer.MarkerClusterer({
          map,
          markers,
          algorithm: new markerClusterer.SuperClusterAlgorithm({
            radius: 100,
            maxZoom: 16,
          }),
        });
      }

      window.onload = initMap;
    </script>
  </body>
</html>
