<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台北市 Ubike 站點查詢</title>
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
    />
    <!-- Leaflet -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

    <style>
      #map {
        height: calc(100vh - 56px);
      }
      .leaflet-popup-content {
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <h1 class="text-light navbar-brand m-0">台北市 Ubike 站點查詢</h1>
      </div>
    </nav>

    <div class="bg-light p-2">
      <div class="btn-group w-100" role="group">
        <button
          type="button"
          class="btn btn-primary"
          onclick="window.location.href='./combine_Gmap_LeafletMap2.html'"
        >
          Google Maps
        </button>
        <button
          type="button"
          class="btn btn-primary active"
          onclick="window.location.href='./combine_Gmap_LeafLetMap.html'"
        >
          Leaflet
        </button>
      </div>
    </div>

    <div id="map"></div>
    <script>
      // Leaflet Map initialization
      let map;
      let markerCluster;

      function initMap() {
        map = L.map("map").setView([25.03416068163684, 121.56454962636319], 12);

        // 添加 OpenStreetMap 圖層
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        // 初始化 MarkerCluster
        markerCluster = L.markerClusterGroup();
        map.addLayer(markerCluster);

        // 載入資料和設置標記
        fetchUbikeData();
      }

      async function fetchUbikeData() {
        const UBIKE_TAIPEI =
          "https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json";
        const data = await fetch(UBIKE_TAIPEI).then((res) => res.json());

        data.forEach((station) => {
          // 創建標記
          const marker = L.marker([station.latitude, station.longitude]);

          // 創建彈出視窗內容
          const popupContent = `
            <div class="p-3">
              <div class="mb-3">
                <h5 class="mb-2">${station.sna.split("_")[1]}</h5>
                <p class="mb-1"><i class="fa-solid fa-location-dot me-2"></i>${
                  station.ar
                }</p>
                <p class="mb-1"><i class="fa-solid fa-map me-2"></i>${
                  station.sarea
                }</p>
              </div>
              
              <div class="mb-3">
                <table class="table table-bordered text-center">
                  <thead class="table-light">
                    <tr>
                      <th>總車位</th>
                      <th>可租借</th>
                      <th>可歸還</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>${station.total}</td>
                      <td class="text-success">${
                        station.available_rent_bikes
                      }</td>
                      <td class="text-primary">${
                        station.available_return_bikes
                      }</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mb-2">
                <p class="mb-1 text-muted small">
                  <i class="fa-regular fa-clock me-2"></i>站點更新：${new Date(
                    station.mday
                  ).toLocaleString()}
                </p>
                <p class="mb-0 text-muted small">
                  <i class="fa-solid fa-rotate me-2"></i>系統更新：${new Date(
                    station.srcUpdateTime
                  ).toLocaleString()}
                </p>
              </div>

              <div class="mt-3 text-center">
                <span class="badge ${
                  station.act === "1" ? "bg-success" : "bg-danger"
                }">
                  <i class="fa-solid ${
                    station.act === "1" ? "fa-check" : "fa-xmark"
                  } me-1"></i>
                  ${station.act === "1" ? "營運中" : "暫停營運"}
                </span>
              </div>
            </div>
          `;

          // 設置彈出視窗
          marker.bindPopup(popupContent, {
            maxWidth: 300,
            className: "custom-popup",
          });

          // 將標記添加到 MarkerCluster
          markerCluster.addLayer(marker);
        });
      }

      window.onload = initMap;
    </script>
  </body>
</html>
